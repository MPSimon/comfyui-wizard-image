version: 2.1

executors:
  docker-dind:
    machine:
      image: ubuntu-2404:current
      docker_layer_caching: false
    environment:
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build_and_push:
    executor: docker-dind
    steps:
      - checkout
      - run:
          name: Log in to Docker Hub
          command: |
            echo "$DOCKERHUB_PAT" | docker login -u "$DOCKERHUB_USER" --password-stdin
      - run:
          name: Compute image tag
          command: |
            if [ -n "${CIRCLE_TAG}" ]; then
              echo "export IMAGE_TAG=${CIRCLE_TAG}" >> "$BASH_ENV"
            else
              echo "export IMAGE_TAG=main-${CIRCLE_SHA1:0:7}" >> "$BASH_ENV"
            fi
      - run:
          name: Build & push
          no_output_timeout: 45m
          command: |
            source "$BASH_ENV"
            IMG="docker.io/$DOCKERHUB_USER/comfyui-wizard-image"
            (
              while true; do
                echo "[keepalive] docker build still running at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                sleep 60
              done
            ) &
            KEEPALIVE_PID=$!

            set +e
            docker build --progress=plain \
              --build-arg SAGE_CUDA_ARCH_LIST="${SAGE_CUDA_ARCH_LIST:-8.9}" \
              --build-arg SAGE_MAX_JOBS="${SAGE_MAX_JOBS:-4}" \
              --build-arg SAGE_EXT_PARALLEL="${SAGE_EXT_PARALLEL:-1}" \
              --build-arg SAGE_NVCC_THREADS="${SAGE_NVCC_THREADS:-2}" \
              -t "${IMG}:${IMAGE_TAG}" .
            BUILD_RC=$?
            set -e

            kill "${KEEPALIVE_PID}" >/dev/null 2>&1 || true
            wait "${KEEPALIVE_PID}" 2>/dev/null || true

            if [ "${BUILD_RC}" -ne 0 ]; then
              exit "${BUILD_RC}"
            fi

            docker push "${IMG}:${IMAGE_TAG}"
      - run:
          name: Push latest on main or version tag
          command: |
            if [ "${CIRCLE_BRANCH}" = "main" ] || echo "${CIRCLE_TAG}" | grep -Eq '^v[0-9]+(\.[0-9]+)*$'; then
              source "$BASH_ENV"
              IMG="docker.io/$DOCKERHUB_USER/comfyui-wizard-image"
              docker tag "${IMG}:${IMAGE_TAG}" "${IMG}:latest"
              docker push "${IMG}:latest"
            fi

workflows:
  version: 2
  build_on_main_and_tag:
    jobs:
      - build_and_push:
          name: build_and_push_main
          context: docker-hub
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
      - build_and_push:
          name: build_and_push_tag
          context: docker-hub
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
