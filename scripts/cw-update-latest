#!/usr/bin/env bash
set -euo pipefail

CW_ROOT="${COMFYWIZARD_HOME:-/opt/ComfyWizard}"
CW_REPO="${COMFYWIZARD_REPO:-https://github.com/MPSimon/ComfyWizard.git}"
CW_BRANCH="${COMFYWIZARD_BRANCH:-main}"

if [ -d "$CW_ROOT/.git" ]; then
  git -C "$CW_ROOT" fetch --all --prune
  git -C "$CW_ROOT" checkout "$CW_BRANCH"
  git -C "$CW_ROOT" pull --ff-only origin "$CW_BRANCH"
else
  rm -rf "$CW_ROOT"
  git clone --branch "$CW_BRANCH" --single-branch "$CW_REPO" "$CW_ROOT"
fi

chmod +x "$CW_ROOT/bin/sync.sh" "$CW_ROOT/bin/wizard.sh"
echo "ComfyWizard updated: $(git -C "$CW_ROOT" rev-parse HEAD)"
